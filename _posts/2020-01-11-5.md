---
published: true
layout: single
title: "Terraform"
comments: true
categories:
  - Infra
---


## Terraform이란?
HashiCorp 에서 만든 오픈 소스로 코드 프로비저닝을 통해 인프라를 구축 및 관리 할 수 있게 해주는 도구 입니다.  

[Terraform 공식 홈페이지](https://www.terraform.io)

이글에서는 Terraform v0.12.19 version을 기준으로 알아보도록 하겠습니다.  

## Terraform 설치
[Terraform 다운로드](https://www.terraform.io/downloads.html)에서 직접 다운받아 설치를 할 수도 있고,  
Mac에서의 경우 homebrew를 통해 설치 할 수 있습니다.  
저는 homebrew명령어를 통해 설치 해 보겠습니다.  
{% highlight Bash %}
brew install terraform
{% endhighlight %}

설치가 완료 되었으면 version 확인 및 사용법을 확인 해 볼 수 있습니다.  
#### version 확인
{% highlight Bash %}
terraform -version
{% endhighlight %}

#### 사용법 확인
{% highlight Bash %}
terraform --help [commands]
{% endhighlight %}

## Terraform 주요 개념

### Providers
- Terraform은 거의 모든 인프라 유형을 정의 할 수 있는데, 이때 구성할 인프라의 종류를 Provider를 통해 설정합니다.  
- Provider는 하나의 cloud 또는 on-premises 구조에 대응되는 개념입니다.  
- 설정한 Provider에 따라 사용가능한 Resources타입이 제공됩니다.  
- AWS, Microsoft Azure, Heroku, Github, Bitbucket 등등 셀 수 없이 많은 종류의 인프라를 Provider로 설정 가능합니다.  
  - [Providers 종류](https://www.terraform.io/docs/providers/index.html)  

제가 구성해 볼 Provider는 AWS입니다. 아래와 같은 구조로 설정 할 수 있습니다.  
{% highlight Bash %}
provider "aws" {
  region  = "us-east-1"
}
{% endhighlight %}


### Resources
- Resources는 Terraform의 제일 중요한 개념으로, Provider로 지정한 인프라를 구성할 개체를 나타냅니다.  
- Provider의 설정에 따라 지원되는 Resource가 달라집니다.  

{% highlight Bash %}
resource "aws_instance" "test" {
  ami           = "ami-a1b2c3d4"
  instance_type = "t2.micro"
}
{% endhighlight %}
- 위의 코드는 Provider를 aws로 설정했을때 조작할수 있는 aws_instance를 리소스를 정의했으며, 해당 리소스를 test라는 이름으로 관리 하겠다는 의미가 됩니다.  
- ami, instance_type는 resource유형에 따라 지원되는 인수입니다.

### Input Variables
- 외부의 입력을 받아 모듈간의 매개변수로 사용되는 값입니다.  
- 모듈내에서 고유한 이름으로 선언 되어야 합니다.  
{% highlight Bash %}
variable "image_id" {
  type = string
  description = "~~~"
}

variable "availability_zone_names" {
  type    = list(string)
  default = ["us-west-1a"]
}
{% endhighlight %}
- 각 입력변수는 variable '변수명' 으로 블럭을 생성합니다.  
- '변수명'은 외부에서 입력받은 값이 할당되며, 모듈내에서 '변수명'을 통해 사용할 수 있습니다.  
- type 인수는 외부에서 입력받는 값을 type값에 따라 제한 할 수 있습니다.
- string,number, bool, list, set, map, object등의 type으로 제한 할 수 있습니다.  
- default 인수는 입력값이 없을시 기본값을 지정합니다.  
- description 인수에 각 변수의 목적을 설명할 수 있습니다.  
- 선언된 Input Variables는 모듈내에서 var.<NAME>으로 사용할 수 있습니다.  

#### Example
{% highlight Bash %}
resource "aws_instance" "example" {
  instance_type = "t2.micro"
  ami           = var.image_id
}
{% endhighlight %}

### Output Values
- Output Value는 Terraform모듈이 반환될때의 출력값이라고 할 수 있습니다.  
- 루트 모듈에서 정의된 Output Value의 경우에만 사용자에게 보여집니다.  
- 루트 모듈이 아닌 하위모듈에서 정의된 Output value는 상위모듈의 식으로 사용됩니다.  
- terraform plan시에는 출력되지 않으며, terraform apply를 할때만 출력됩니다.  
{% highlight Bash %}
output "instance_ip_addr" {
  value = aws_instance.server.private_ip
}
{% endhighlight %}
"instance_ip_addr"라는 명칭으로 aws_instance.server.private_ip를 return 하겠다는 코드입니다.  

### Local Values
- 모듈내 변수를 정의합니다.  
{% highlight Bash %}
locals {
  service_name = "forum"
  owner        = "Community Team"
  common_tags = {
    Service = local.service_name
    Owner   = local.owner
  }
}
{% endhighlight %}
service_name, owner라는 모듈내에서 사용가능한 변수를 정의한 코드입니다.  

#### 사용방법 
{% highlight Bash %}
resource "aws_instance" "example" {
  # ...

  tags = local.common_tags
}
{% endhighlight %}

### Modules
- 한개이상의 Resource를 함께 사용하기 위해 담는 container입니다.  
- 하나의 모듈은 .tf 확장자로 끝나는 파일로 만들어 집니다.   
- 또한 모든 Terraform은 root Module을 포함한 하나이상의 module을 가지고 있습니다.  
- module내에서 다른 module을 하위 모듀로 사용하기 위해 source 인수를 사용합니다.
- module을 생성 또는 수정한 경우, **terraform init** 명령어를 통해 재실행 해주어야 합니다. 

{% highlight Bash %}
module "servers" {
  source = "./app-cluster"
  version = "0.0.5"
  servers = 5
}
{% endhighlight %}
- "servers"라는 이름은 선언된 모듈입니다.  
- source 인수는 경로 또는 URL을 설정하여 호출된 모듈을 참조하여 사용할 수 있습니다.  
- version 인수는 버전을 지정하는 버전 제한 문자열입니다. 참조할 때 버전 조건을 통해 원하는 버전의 모듈을 참조 할 수 있습니다.  

### .tf
- Terraform은 모든 파일을 .tf확장자를 사용하여 작성합니다.  
- .tf파일은 HCL언어를 사용하는데, HCL는 Terraform을 만든 Hashicorp에서 자체 Application을 구성하기 위해 만들어진 언어입니다.  



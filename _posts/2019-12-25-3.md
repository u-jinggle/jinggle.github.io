---
published: true
layout: single
title: "imageproxy를 이용한 image resize"
comments: true
categories:
  - Infra
---

대부분의 서비스에서 이미지는 정말 중요한 정보입니다.  
같은 이미지라도 페이지에 따라 각각 다른 크기로 노출을 시켜 주고 있습니다.  
이미지 크기를 변경시키는 Image resize는 크게 
1. 원하는 이미지 크기만큼 저장을 시켜 사용하는 **썸네일 저장**
2. 원본의 이미지를 사용자의 요청이 있을때 resize해서 사용하는 **On-demand Image Resizing 방식**

으로 나눌 수 있습니다.  
그중에서 On-demand Image Resizing 방식에 해당하는 **imageproxy**를 적용하는 방법에 대해 알아보겠습니다.

imageproxy는 go로 작성되어 속도가 매우 빠르며, resize뿐만 아니라 기본적인 이미지 조정, 워터마크, 엑세스 제어등 다양한 옵션을 제공하고 있습니다.  
imgproxy homepage : [https://docs.imgproxy.net](https://docs.imgproxy.net)  
imgproxy github : [https://github.com/willnorris/imageproxy](https://github.com/willnorris/imageproxy)

Docker, Heroku, Packages, Source를 통해 설치해 할 수 있다고 합니다.  
저는 AWS에 ec2에 Docker를 통해 설치해 보도록 하겠습니다. 
 
## ec2 생성
ec2는 다른 부가 기능 없이 docker를 띄워 imageproxy 기능만 수행할 것이기 때문에 제일 기본적인 옵션으로 생성해 주도록 하겠습니다.  
### 단계 1: Amazon Machine Image(AMI) 선택
뒤에서 docker를 설치할 것이기 때문에 가장 기본적인 AMI를 선택해 주도록 하겠습니다.  
![ec2생성 예시이미지](/assets/images/2019-12-25_9.png){: width="100%"} 
 

다른 단계들은 default대로 진행해 줍니다.  
### 단계 6: 보안 그룹 구성
ssh 접속을 위한 22 포트와 http를 통해 이미지 리사이징을 확인해 보기위한 80 포트를 추가해 줍니다.  
(저는 빠른 테스트를 위해 넘겼지만, 보안을 더 탄탄히 해주시는게 좋습니다.)    
![ec2보안그룹 예시이미지](/assets/images/2019-12-25_2.png){: width="100%"} 

## docker를 통해 imgproxy실행
### docker 설치
yum패키지를 사용해 docker를 설치해 줍니다.
#### 실행
{% highlight Bash %}
sudo yum install -y docker
{% endhighlight %}
#### 결과  
![docker 실행에러 예시이미지](/assets/images/2019-12-25_3.png){: width="100%"}

docker를 통해 imgproxy를 실행시키려 했으나 위와같은 오류가 발생되었습니다.  
docker의 데몬이 실행되고 있지 않다는 오류입니다.  
docker 데몬은 컨테이너들을 관리하는 백그라운드 프로세스인데, 데몬 실행후 docker를 실행시킬 수 있습니다.  
{% highlight Bash %}
sudo systemctl start docker.service
{% endhighlight %}
위와같이 실행시켜 docker 데몬을 실행시켜 줍니다.  

### imgproxy 실행
이제 imgproxy README.md에서 설명하는 대로 imgproxy docker를 실행시켜 줍니다.  
#### 실행
{% highlight Bash %}
sudo docker run -p 80:8080 willnorris/imageproxy
{% endhighlight %}
#### 결과
![docker imgproxy 실행 예시이미지](/assets/images/2019-12-25_10.png){: width="100%"}  

이미지와 같이 imgproxy가 실행중입니다.  
![docker imgproxy 실행 예시이미지2](/assets/images/2019-12-25_7.png){: width="100%"}  

이때 웹사이트를 확인해 보면 위와같이 ok가 출력되고 있습니다. 

### Image resize
imgproxy를 실행 시켰으니 실제 이미지가 resize되는지 확인해 보아야 겠습니다.  
  
![s3 이미지](/assets/images/2019-12-25_6.png){: width="100%"}  

위의 같이 미리 올려둔 s3의 이미지를 통해 테스트 해보도록 하겠습니다.
- #### imgproxy호출 URL형식 : http://localhost/{options}/{remote_url}  

이러한 형태로 imgproxy를 원본이미지에 적용 시켜 볼 수 있습니다.  

![s3 이미지](/assets/images/2019-12-25_8.png){: width="100%"}

option으로 지정한 대로 폭이 100px로 resize되었습니다.  
resize외에도 [imgproxy](https://docs.imgproxy.net)에서는 다양한 옵션을 제공하고 있습니다.    

간편한 설치와 사용법 그리고 속도까지..(실제 테스트 앱에 적용해보니 빠른 속도를 체감해 볼수 있었습니다)  
실행해 보는 내내 감탄을 연발하게 하는 imgproxy였습니다.










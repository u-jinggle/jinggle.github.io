---
published: true
layout: single
title: "Mockito"
category: post
comments: true 
---

*본문은 백기선 강사님의 '더 자바, 애플리케이션을 테스트하는 다양한 방법' 강의를 듣고 정리한 내용입니다.*

## Mockito
- mock을 지원하는 framework
- mock이란? 실제 객체와 동일하나 프로그래머가 직접 control 가능한 객체를 mock객체
- Mockito는 mock객체를 만들고, 관리하고 검증하게 만들어 주는 framework중에 하나입니다.
- 직접 control하기 힘든 외부 서비스가 필요한 서비스에서 외부서비스의 역할을 대행해주는 역할로 사용할 수 있습니다.

[Mockito 공식 문서](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)

## 설치
- spring boot starter로 프로젝트 생성시, 자동으로 주입됩니다.
- spring boot starter를 사용하지 않는경우, mockito-junit-jupiter + mockito-core 의존성 주입을 직접 해주면 가능합니다.

## Mock객체 만들어 사용하기
아래 예제 소스에서 testRepository는 실제 존재하지 않는 객체입니다.  
testRepository 객체에 해당하는 mock을 만들어 테스트를 정상적으로 실행 시킬 수 있습니다.
### 코드를 사용한 방법
{% highlight Java %}
class StudyServiceTest {
    TestRepository testRepository = Mockito.mock(TestRepository.class);
    
    void createService() {
        StudyService studyService = new StudyService(testRepository);
    }
}
{% endhighlight %}

### mock annotation을 사용한 방법(전역적으로 생성됨)
- mock 객체를 여러 테스트에서 사용하는 경우 편리합니다.
{% highlight Java %}
@ExtendWith(MockitoExtension.class)     //필수
class StudyServiceTest {
    
    @Mock
    TestRepository testRepository;

    void createService() {
        StudyService studyService = new StudyService(testRepository);
    }
}
{% endhighlight %}

### mock을 전역적으로 생성하지 않고 해당 method에서만 생성하는 방법
{% highlight Java %}
@ExtendWith(MockitoExtension.class)     //필수
class StudyServiceTest {
    void createService(@Mock TestRepository testRepository) {
        StudyService studyService = new StudyService(testRepository);
    }
}
{% endhighlight %}

## Stubbing
Mockito로 만든 객체의 행동을 조작하는 방법 입니다.  

#### memberService의 findById를 1 값으로 호출했을때, Stubbing하여 member를 return 하는 방법
{% highlight Java %}
Member member = new Member();
member.setId(1L);
member.setEmail("jinggle@email.com");

when(memberService.findById(1L).thenReturn(Optional.of(member));        //Stubbing

Optional<Member> findById = memberService.findById(1L);
assertEquals("jinggle@email.com",findById.get().getEmail());

{% endhighlight %}

#### memberService의 findById를 어떤 값으로라도 호출했을때, Stubbing하여 예외를 throw 하는 방법(retrun type이 있는경우)
{% highlight Java %}
Member member = new Member();
member.setId(1L);
member.setEmail("jinggle@email.com");

when(memberService.findById(any()).thenThrow(new RuntimeException()));    //Stubbing

Optional<Member> findById = memberService.findById(1L);
assertEquals("jinggle@email.com",findById.get().getEmail());

{% endhighlight %}

#### memberService의 findById를 어떤 값으로라도 호출했을때, Stubbing하여 예외를 throw 하는 방법(void method의 경우)
{% highlight Java %}
Member member = new Member();
member.setId(1L);
member.setEmail("jinggle@email.com");

doThrow(new IllegalArgumentException()).when(memberService).validate(1L);   //Stubbing

assertThrows(IllegalArgumentException.class,()-> {
    memberService.validate(1L);
});
{% endhighlight %}

#### memberService의 findById를 어떤 값으로라도 호출했을때, 호출순서에 따라 Stubbing 여러개를 한번에 설정하는 방법
{% highlight Java %}
Member member = new Member();
member.setId(1L);
member.setEmail("jinggle@email.com");

when(memberService.findById(any()))
        .thenReturn(Optional.of(member))
        .thenThrow(new RuntimeException())
        .thenReturn(Optional.empty());

assertEquals("jinggle@email.com",memberService.findById(1L));   //thenReturn(Optional.of(member)) 검증

assertThrows(IllegalArgumentException.class,()-> {              //thenThrow(new RuntimeException()) 검증
    memberService.validate(1L);
});

assertEquals(Optional.empty(),memberService.findById(3L));      //thenReturn(Optional.empty()) 검증
{% endhighlight %}


## Mock 객체 확인
mock 객체에 어떤 일이 일어나는지 확인 할 수 있습니다.

{% highlight Java %}
verify(memberService, times(1)).notify(study);  //memberService에서 study를 객체로 받는 notify Method가 1번 호출이 됐나를 확인

verify(memberService, times(2)).notify(member); //memberService에서 member를 객체로 받는 notify Method가 2번 호출이 됐나를 확인

verify(memberService, never()).validate(any());     //memberService에서 validate Method가 실행되지 않았는지를 확인

InOrder inOrder = inOrder(memberService);
inOrder.verify(memberService).notify(member);
inOrder.verify(memberService).notify(study);        //memberService의 객체가 member 다음 study 순으로 호출되었는지를 확인

verifyNoInteractions(memberService);    //verify문 뒤에 붙이면 해당 verify 이후론 할 필요가 없는 것으로 그다음 method가 호출되었을떄 error를 출력
{% endhighlight %}

## BDD 스타일의 Mockito API
- BDD란? Application이 어떻게 행동해야 하는지에 대한 공통된 이해를 구성하는 방법입니다.
- As a / I want / So that
    - As a : 어떤 역할로써
    - I want : 하고싶은 것을
    - So that : 할수있는 행위?
- Given / When / Then
    - Given : 어떠한 상황이 주어졌을때
    - When : 무엇을 하면
    - Then : 어떻게 될것이다

Mockito를 BDD스타일로 작성할 수 있는 BDD Mockito Class가 제공됩니다.

### when -> given
{% highlight Java %}
when(memberService.findById(1L)).thenReturn(Optional.of(member));   //when

given(memberService.findById(1L)).willReturn(Optional.of(member));  //given
{% endhighlight %}

### verify -> then
{% highlight Java %}
verify(memberService, times(1)).notify(study);      //verify           
then(memberService).should(times(1)).notify(study); //then

verifyNoInteractions(memberService);    //verify
then(memberService).shouldHaveNoInteractions(); //then
{% endhighlight %}